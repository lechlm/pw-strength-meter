<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<!--
An element for checking the password complexity.

Example:

  <pw-strength-meter></pw-strength-meter>

@demo
-->
<dom-module id="pw-strength-meter">

<style>
  :host {
    display: inline-block;
    @apply(--pw-strength-meter);
  }

  [hidden] {
    display: none;
  }

  iron-icon {
    margin-right: -3px;
    --iron-icon-width: var(--pw-strength-meter-icon-size, 24px);
    --iron-icon-height: var(--pw-strength-meter-icon-size, 24px);
  }

  .icon-lock-open {
    fill: #BBBCBC;
  }

  .icon-strong {
    fill: var(--pw-strength-meter-strong-color, #55BB4B);
  }

  .icon-medium {
    fill: var(--pw-strength-meter-medium-color, #E9AB27);
  }

  .icon-weak {
    fill: var(--pw-strength-meter-weak-color, #D93B26);
  }
</style>

<template>
  <div id="iconContainer"></div>
  <div id="weakMsg" hidden$="[[!_showWeakMsg(rating)]]">
    <content select="[weak]"></content>
  </div>
  <div id="mediumMsg" hidden$="[[!_showMediumMsg(rating)]]">
    <content select="[medium]"></content>
  </div>
  <div id="strongMsg" hidden$="[[!_showStrongMsg(rating)]]">
    <content select="[strong]"></content>
  </div>
</template>

</dom-module>

<script>

Polymer({

  is: 'pw-strength-meter',

  properties: {

    /**
    * currently entered password
    */
    password: {
      type: String,
      observer: '_passwordChanged'
    },

    /**
    * returns the current rating depending on the currently entered password.
    *
    * minimum value: 0
    *
    * maximum value: 10
    */
    rating: {
      type: Number,
      readOnly: true,
      value: 0
    },


    /**
    * constant for icon types
    */
    _iconTypes: {
      type: Object,
      readOnly: true,
      value: function() {
        return {
          lock: {
            type: String,
            value: "lock"
          },

          lockOpen: {
            type: String,
            value: "lock-open"
          }
        };
      }
    }
  },

  // Element Behavior

  _applyRating: function() {
    // determine class value and message type depending on the new password rating
    if(this.rating<=4) {
      iconClass = 'icon-weak';
    } else if(this.rating<=8) {
      iconClass = 'icon-medium';
    } else {
      iconClass = 'icon-strong';
    }

    // init dom sections
    Polymer.dom(this.$.iconContainer).textContent = '';

    // fill icon section
    for(i=1; i<=10; i++) {
      icon = document.createElement('iron-icon');

      if(i<=this.rating) {
        icon.icon      = this._iconTypes.lock.value;
        icon.classList.add(iconClass);
      } else {
        icon.icon      = this._iconTypes.lockOpen.value;
        icon.classList.add('icon-lock-open');
      }

      Polymer.dom(this.$.iconContainer).appendChild(icon);
    }
  },

  /**
   * Show message for weak passwords if rating is <= 4.
   */
  _showWeakMsg: function() {
    return this.rating <= 4;
  },

  /**
   * Show message for medium passwords if 4 < rating <= 8.
   */
  _showMediumMsg: function() {
    return this.rating > 4 && this.rating <= 8;
  },

  /**
   * Show message for strong passwords if rating is > 8.
   */
  _showStrongMsg: function() {
    return this.rating > 8;
  },

  /**
  * determine password complexity
  */
  _passwordChanged: function() {
    var rating = 0;

    // a password with less than eight characters is always weak
    if(this.password.length < 8) {
      if (this.password) {
        rating = 1;
      }
      this._setRating(rating);
      this._applyRating();
      return;
    }

    // award every unique letter
    var letters = new Object();
    for (var i=0; i<this.password.length; i++) {
      letters[this.password[i]] = (letters[this.password[i]] || 0) + 1;
      rating = rating + (0.2 / letters[this.password[i]]);
    }

    // set a maximum of 4 for length and variation of characters
    if(rating > 4) {
      rating = 4;
    }

    // bonus points for mixing it up
    var variations = {
      digits: /\d/.test(this.password),
      lower: /[a-z]/.test(this.password),
      upper: /[A-Z]/.test(this.password),
      nonWords: /\W/.test(this.password),
    }

    var variationCount = 0;
    for (var check in variations) {
      variationCount += (variations[check] == true) ? 1.5 : 0;
    }
    rating = Math.round(rating + variationCount);

    this._setRating(rating);
    this._applyRating();
  },

  // Element Lifecycle

  ready: function () {

    // initialize lock icons
    this._applyRating();
  }

});

</script>
